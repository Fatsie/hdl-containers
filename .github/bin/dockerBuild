#!/usr/bin/env sh

# Authors:
#   Unai Martinez-Corral
#
# Copyright 2021 Unai Martinez-Corral <unai.martinezcorral@ehu.eus>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

set -e

unset _target
unset _argimg

# Transform long options to short ones
for arg in "$@"; do
  shift
  case "$arg" in
      "--baseos"|"-b")     set -- "$@" "-b";;
      "--image"|"-i")      set -- "$@" "-i";;
      "--dockerfile"|"-d") set -- "$@" "-d";;
      "--target"|"-t")     set -- "$@" "-t";;
      "--argimg"|"-a")     set -- "$@" "-a";;
    *) set -- "$@" "$arg"
  esac
done
# Parse args
while getopts ":b:i:d:t:a:" opt; do
  case $opt in
    b) _baseos="$OPTARG";;
    i) _image="$OPTARG";;
    d) _dockerfile="$OPTARG".dockerfile;;
    t) _target='--target='"$OPTARG";;
    a) _argimg='--build-arg IMAGE='"$OPTARG";;
    \?) printf "[dockerBuild] Invalid option: -$OPTARG\n" >&2
        exit 1 ;;
    :)  printf "[dockerBuild] Option -$OPTARG requires an argument\n" >&2
        exit 1 ;;
  esac
done
shift $((OPTIND -1))

docker build --progress=plain --build-arg BUILDKIT_INLINE_CACHE=1 \
  -t ghcr.io/hdl/"${_baseos}"/"${_image}" ${_target} ${_argimg} \
  - < "${_baseos}"/"${_dockerfile}"
